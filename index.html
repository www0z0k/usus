<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–£–∑—É—Å</title>
  <style>
    :root{
      --bg:#0f1115;--fg:#e6e9ef;--muted:#aab1bd;--acc:#7c9cff;--acc2:#9bdead;--bad:#ff6b6b;--good:#38d996;--warn:#ffb020;--card:#171a21;--card2:#13161c;--br:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial,sans-serif;background:var(--bg);color:var(--fg)}
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    h1{font-size:28px;margin:0 0 12px}
    h2{font-size:20px;margin:24px 0 12px;color:var(--acc)}
    .card{background:linear-gradient(180deg,var(--card),var(--card2));border:1px solid #22293a;border-radius:var(--br);padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width:760px){.g2,.g3{grid-template-columns:1fr}
      /* mobile-friendly deck rows: stack fields */
      .deck-list{grid-template-columns:1fr}
      #deckHeader{display:none}
      .deck-list > input[type="text"]{width:100%}
    }
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type="text"],input[type="number"],select,textarea{width:100%;background:#0b0e14;color:var(--fg);border:1px solid #273046;border-radius:12px;padding:10px 12px;font-size:14px}
    textarea{min-height:140px;resize:vertical}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid #2b3550;background:#121622;color:var(--fg);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600;transition:.15s}
    .btn:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(0,0,0,.3)}
    .btn.primary{background:var(--acc);border-color:transparent;color:#0b0e14}
    .btn.good{background:var(--good);border-color:transparent;color:#06140f}
    .btn.bad{background:var(--bad);border-color:transparent;color:#220c0c}
    .btn.warn{background:var(--warn);border-color:transparent;color:#261a05}
    .pill{display:inline-flex;align-items:center;gap:6px;background:#0b0e14;border:1px solid #273046;border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
    .sep{height:1px;background:#22293a;margin:16px -16px}

    /* Round UI */
    .timer{display:flex;align-items:center;gap:10px}
    .time{font-variant-numeric:tabular-nums;font-weight:800;font-size:22px}
    .bar{position:relative;height:10px;background:#1a2131;border-radius:999px;overflow:hidden;flex:1}
    .fill{position:absolute;inset:0 100% 0 0;background:linear-gradient(90deg,var(--acc),var(--acc2));transition:width .2s}

    .word{font-size:48px;line-height:1.1;font-weight:900;letter-spacing:.3px;text-align:center;margin:10px 0 6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .hint{font-size:16px;color:var(--muted);text-align:center;min-height:24px}
    .big-actions{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:12px}
    .big-actions .btn{padding:16px 18px;font-size:16px;border-radius:16px}

    .team-tag{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:#0b0e14;border:1px solid #273046}
    .team-color{width:10px;height:10px;border-radius:50%}

    .list{display:flex;flex-wrap:wrap;gap:8px}
    .tag{padding:6px 10px;border-radius:999px;border:1px solid #273046;background:#0b0e14;color:var(--muted);font-size:12px}

    .kbd{padding:2px 6px;border:1px solid #2b3550;border-bottom-width:3px;border-radius:6px;background:#0b0e14;color:#d0d6e3;font-size:12px}

    .footer-note{opacity:.7;font-size:12px;margin-top:8px}

    /* Deck editor */
    .deck-list{display:grid;grid-template-columns:1.2fr 2fr auto;gap:8px;align-items:center}
    .deck-list .hdr{font-size:12px;color:var(--muted)}
    .ghost-btn{background:transparent;border:1px dashed #2b3550;color:var(--fg)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>–£–∑—É—Å</h1>

    <!-- SETUP -->
    <section id="screen-setup" class="card grid g2">
      <div>
        <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–∞—Ç—á–∞</h2>
        <div class="grid g2">
          <div>
            <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–∞–Ω–¥</label>
            <select id="teamCount">
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
            </select>
          </div>
          <div>
            <label>–¶–µ–ª—å –ø–æ –æ—á–∫–∞–º</label>
            <input id="targetScore" type="number" min="5" max="100" step="1" value="30" />
          </div>
          <div>
            <label>–í—Ä–µ–º—è —Ä–∞—É–Ω–¥–∞</label>
            <select id="roundTime">
              <option value="30">30 —Å–µ–∫</option>
              <option value="60" selected>60 —Å–µ–∫</option>
            </select>
          </div>
          <div>
            <label>–®—Ç—Ä–∞—Ñ –∑–∞ –ø—Ä–æ–ø—É—Å–∫</label>
            <select id="skipPenalty">
              <option value="0" selected>0 (–±–µ–∑ —à—Ç—Ä–∞—Ñ–∞)</option>
              <option value="-1">-1 (—Å–æ —à—Ç—Ä–∞—Ñ–æ–º)</option>
            </select>
          </div>
          <div>
            <label>–í–∫–ª—é—á–∏—Ç—å –¥–µ–∫–∏</label>
            <div class="row">
              <label><input type="checkbox" id="enableHigh" checked /> –í—ã—Å–æ–∫–∞—è</label>
              <label><input type="checkbox" id="enableShort" checked /> –ö–æ—Ä–æ—Ç–∫–∞—è</label>
            </div>
          </div>
        </div>
        <div class="sep"></div>
        <h2>–ö–æ–º–∞–Ω–¥—ã</h2>
        <div id="teamsBox" class="grid g1"></div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="rerollNames">üîÅ –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–º–µ–Ω–∞</button>
          <button class="btn" id="swapOrder">üîÄ –ü–µ—Ä–µ–º–µ—à–∞—Ç—å –ø–æ—Ä—è–¥–æ–∫</button>
        </div>
        <div class="sep"></div>
        <div class="row">
          <button class="btn primary" id="startGame">üöÄ –ù–∞—á–∞—Ç—å –º–∞—Ç—á</button>
          <button class="btn" id="howTo">‚ùì –ü—Ä–∞–≤–∏–ª–∞</button>
          <button class="btn" id="historyBtn">üïò –ò—Å—Ç–æ—Ä–∏—è</button>
        </div>
      </div>
      <div>
        <h2>–ö—Ä–∞—Ç–∫–æ –æ –ø—Ä–∞–≤–∏–ª–∞—Ö</h2>
        <div class="list" style="margin-bottom:8px">
          <span class="tag">+2 –±–µ–∑ —Ö–∏–Ω—Ç–∞</span>
          <span class="tag">+1 —Å —Ö–∏–Ω—Ç–æ–º</span>
          <span class="tag">–ü—Ä–æ–ø—É—Å–∫: 0 / ‚àí1</span>
          <span class="tag">–í—Ä–µ–º—è: 30/60</span>
          <span class="tag">–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ –∫—Ä—É–≥—É</span>
        </div>
        <p>–ò–≥—Ä–∞—é—Ç –∫–æ–º–∞–Ω–¥–∞ –Ω–∞ –∫–æ–º–∞–Ω–¥—É. –í –Ω–∞—á–∞–ª–µ —Ä–∞—É–Ω–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å–ª–æ–≤–æ. –ú–æ–∂–Ω–æ <b>–ø–æ–∫–∞–∑–∞—Ç—å —Ö–∏–Ω—Ç</b> (—Ç–æ–≥–¥–∞ —Å–ª–æ–≤–æ —Å—Ç–æ–∏—Ç 1 –æ—á–∫–æ) –∏–ª–∏ –æ–±—ä—è—Å–Ω—è—Ç—å –±–µ–∑ —Ö–∏–Ω—Ç–∞ (2 –æ—á–∫–∞). –ü—Ä–æ–ø—É—Å–∫ ‚Äî –±–µ–∑ —à—Ç—Ä–∞—Ñ–∞ –∏–ª–∏ ‚àí1 (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è).
        –ö–æ–≥–¥–∞ –≤—Ä–µ–º—è –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è ‚Äî <b>–ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–ª–æ–≤–æ</b> –º–æ–∂–Ω–æ –æ–±—ä—è—Å–Ω—è—Ç—å –±–µ–∑ –ª–∏–º–∏—Ç–∞, –∑–∞—Ç–µ–º —Ä–∞—É–Ω–¥ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è.</p>
        <p class="footer-note">–í—Å–µ –¥–∞–Ω–Ω—ã–µ (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –¥–µ–∫–∏, –∏—Å—Ç–æ—Ä–∏—è) —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ <span class="kbd">localStorage</span>.</p>
      </div>
    </section>

    <!-- ROUND / PLAY -->
    <section id="screen-round" class="card" style="display:none">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div id="roundTeamTag" class="team-tag"><span class="team-color"></span><span class="name"></span></div>
        <div class="timer" style="min-width:260px">
          <div class="time" id="timeLeft">00:60</div>
          <div class="bar"><div id="barFill" class="fill"></div></div>
        </div>
        <div class="pill" id="roundInfo">–†–∞—É–Ω–¥ 1</div>
      </div>
      <div class="sep"></div>
      <div class="word" id="wordText">‚Äî</div>
      <div class="hint" id="hintText">–ü–æ–¥—Å–∫–∞–∑–∫–∞ —Å–∫—Ä—ã—Ç–∞</div>

      <div class="big-actions">
        <button class="btn" id="btnHint">üí° –ü–æ–∫–∞–∑–∞—Ç—å —Ö–∏–Ω—Ç</button>
        <button class="btn good" id="btnGuessed">‚úÖ –û—Ç–≥–∞–¥–∞–ª–∏ ‚Üí</button>
        <button class="btn bad" id="btnSkip">‚è≠ –ü—Ä–æ–ø—É—Å–∫</button>
      </div>
      <div class="row" style="justify-content:space-between;margin-top:10px">
        <div class="pill" id="scoreTag">–°—á—ë—Ç: ‚Äî</div>
        <div class="row">
          <button class="btn" id="btnPause">‚è∏ –ü–∞—É–∑–∞</button>
          <button class="btn warn" id="btnEndRound">‚è± –í—Ä–µ–º—è!</button>
        </div>
      </div>
    </section>

    <!-- SCOREBOARD / SUMMARY -->
    <section id="screen-score" class="card" style="display:none">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2>–°–≤–æ–¥–∫–∞ —Ä–∞—É–Ω–¥–∞</h2>
        <button class="btn" id="btnNextTeam">‚ñ∂Ô∏è –°–ª–µ–¥—É—é—â–∞—è –∫–æ–º–∞–Ω–¥–∞</button>
      </div>
      <div id="scoreTable" class="grid g2"></div>
      <div class="sep"></div>
      <div>
        <h3 style="margin:0 0 8px">–°–ª–æ–≤–∞ —Ä–∞—É–Ω–¥–∞</h3>
        <div id="wordsSummary"></div>
      </div>
    </section>

    <!-- MATCH END -->
    <section id="screen-end" class="card" style="display:none">
      <h2 id="winnerTitle">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å</h2>
      <div id="finalScore" class="grid g2"></div>
      <div class="row" style="margin-top:12px">
        <button class="btn primary" id="btnRematch">üîÑ –†–µ–≤–∞–Ω—à</button>
        <button class="btn" id="btnNew">üÜï –ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
        <button class="btn" id="btnHistoryFromEnd">üïò –ò—Å—Ç–æ—Ä–∏—è</button>
      </div>
    </section>



    <!-- HISTORY -->
    <section id="screen-history" class="card" style="display:none">
      <h2>–ò—Å—Ç–æ—Ä–∏—è –º–∞—Ç—á–µ–π (localStorage)</h2>
      <div id="historyList"></div>
      <div class="row" style="margin-top:10px">
        <button class="btn bad" id="clearHistory">üóë –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
        <button class="btn" id="backFromHistory">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</button>
      </div>
    </section>

  </div>

  <script>
    // ---------- Utilities ----------
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const fmt = s => s.toString().padStart(2,'0');
    const choice = arr => arr[Math.floor(Math.random()*arr.length)];
    const uid = () => Math.random().toString(36).slice(2,10);

    // ---------- Team name generator (unique per roll) ----------
    const ADJ = [
      '–°—É—Ä–æ–≤—ã–µ','–ö–æ—Å–º–∏—á–µ—Å–∫–∏–µ','–ë–ª–∞–≥–æ—Ä–æ–¥–Ω—ã–µ','–°—Ç—Ä–µ–º–∏—Ç–µ–ª—å–Ω—ã–µ','–õ—É–Ω–Ω—ã–µ','–ì—Ä–æ–∑–Ω—ã–µ','–ñ–µ–ª–µ–∑–Ω—ã–µ','–•—Ä—É—Å—Ç–∞–ª—å–Ω—ã–µ','–ë–∞—Ä—Ö–∞—Ç–Ω—ã–µ','–°–º–∏—Ä–µ–Ω–Ω—ã–µ','–ù–µ–ø–æ–∫–æ–ª–µ–±–∏–º—ã–µ','–ü—Ä–æ–≤–æ—Ä–Ω—ã–µ','–ò—Å–∫—Ä–∏—Å—Ç—ã–µ','–¢—É–º–∞–Ω–Ω—ã–µ','–õ–∏—Ö–∏–µ','–ê–ª—ã–µ','–°–∞–ø—Ñ–∏—Ä–æ–≤—ã–µ','–í–µ—Ç—Ä—è–Ω—ã–µ','–ó–≤–æ–Ω–∫–∏–µ','–ú–µ–¥–Ω—ã–µ','–°–µ—Ä–µ–±—Ä—è–Ω—ã–µ','–°–æ–ª–Ω–µ—á–Ω—ã–µ','–ü–æ–ª—è—Ä–Ω—ã–µ','–Ø—Ä–æ—Å—Ç–Ω—ã–µ','–ù–µ–ø—Ä–∏–Ω—É–∂–¥—ë–Ω–Ω—ã–µ','–ö–∏—Ä–ø–∏—á–Ω—ã–µ','–°–µ—Ä–¥–∏—Ç—ã–µ','–ú—è—Ç–Ω—ã–µ','–Ø–Ω—Ç–∞—Ä–Ω—ã–µ','–§–ª–∞–∂–Ω—ã–µ','–ü–æ–ª–µ–≤—ã–µ','–°—Ç–µ–ø–Ω—ã–µ','–ü—Ä–∞–∑–¥–Ω—ã–µ','–î–µ—Ä–∑–∫–∏–µ','–ù–µ–∑—Ä–∏–º—ã–µ','–ú–æ—Ç–æ—Ä–Ω—ã–µ','–õ–∞–¥–Ω—ã–µ','–õ–µ—Å–Ω—ã–µ','–°–∫–∞–∑–æ—á–Ω—ã–µ'
    ];
    const NOUN = [
      '–ü–æ–Ω–∏','–ü–æ–∂–∞—Ä–Ω—ã–µ','–ë–æ–±—Ä—ã','–°–∞–º–æ–≤–∞—Ä—ã','–°—É—Å–ª–∏–∫–∏','–¢–∏–≥—Ä—ã','–ö–∏—Ç—ã','–õ–æ—Å–æ—Å–∏','–ö–µ–Ω—Ç–∞–≤—Ä—ã','–°–æ–∫–æ–ª—ã','–ï–Ω–æ—Ç—ã','–§–µ—Ö—Ç–æ–≤–∞–ª—å—â–∏–∫–∏','–ò–Ω–∂–µ–Ω–µ—Ä—ã','–ú–∞—Ç—Ä–æ—Å—ã','–ë—É–ª–∞–≤—ã','–ï–∂–µ–≤–∏–∫–∏','–†–æ–º–∞—à–∫–∏','–¢—Ä–∞–∫—Ç–æ—Ä—ã','–ó–æ–Ω—Ç–∏–∫–∏','–®–º–µ–ª–∏','–ù–æ—Å–æ—Ä–æ–≥–∏','–©–µ–≥–ª—ã','–°–æ–ª–æ–≤—å–∏','–ö–∞—Ä–∞—Å–∏','–î–µ–ª—å—Ñ–∏–Ω—ã','–ì–≤–æ–∑–¥–∏','–¢—Ä–∞–º–≤–∞–∏','–ö–∞–∑–∞–∫–∏','–°–µ–º–∞—Ñ–æ—Ä—ã','–ö–∏—Ä–ø–∏—á–∏','–ö–æ—Ä–Ω–µ—Ç—ã','–°–∞–ø—ë—Ä—ã','–ê—Ä—Ñ–∏—Å—Ç—ã','–ì—Ä–∞–º–º–æ—Ñ–æ–Ω—ã','–®—Ç—É—Ä–º–∞–Ω—ã','–í–µ—Ä—Ç–æ–ª—ë—Ç—ã','–õ–∏–±—Ä–µ—Ç—Ç–æ','–õ–æ–¥–æ—á–Ω–∏–∫–∏','–ú—É—Å—Å–æ–Ω—ã'
    ];

    function uniqueTeamNames(n){
      const a = ADJ.slice();
      const b = NOUN.slice();
      // shuffle
      for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}
      for(let i=b.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[b[i],b[j]]=[b[j],b[i]]}
      const names=[];
      for(let i=0;i<n;i++){
        const adj = a[i%a.length];
        const noun = b[i%b.length];
        names.push(`${adj} ${noun}`);
      }
      return names;
    }

    // ---------- Local Storage ----------
    const LS = {
      decksHighKey:'uzus_deck_high',
      decksShortKey:'uzus_deck_short',
      historyKey:'uzus_history',
      saveHigh(obj){localStorage.setItem(this.decksHighKey, JSON.stringify(obj))},
      saveShort(obj){localStorage.setItem(this.decksShortKey, JSON.stringify(obj))},
      getHigh(){try{return JSON.parse(localStorage.getItem(this.decksHighKey)||'{}')}catch{return {}}},
      getShort(){try{return JSON.parse(localStorage.getItem(this.decksShortKey)||'{}')}catch{return {}}},
      pushHistory(rec){const arr=JSON.parse(localStorage.getItem(this.historyKey)||'[]');arr.unshift(rec);localStorage.setItem(this.historyKey,JSON.stringify(arr))},
      getHistory(){return JSON.parse(localStorage.getItem(this.historyKey)||'[]')},
      clearHistory(){localStorage.removeItem(this.historyKey)}
    }

    // ---------- Sample decks (tiny demo; import your full ones) ----------
    const SAMPLE_HIGH = {
      "—É–∑—É—Å":"–û–±—ã—á–∞–π —É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è —è–∑—ã–∫–∞; –æ–±—â–µ–ø—Ä–∏–Ω—è—Ç–∞—è —Ä–µ—á–µ–≤–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞.",
      "—ç–ª–µ–∫—Ç—Ä—É–º":"–ü—Ä–∏—Ä–æ–¥–Ω—ã–π —Å–ø–ª–∞–≤ –∑–æ–ª–æ—Ç–∞ –∏ —Å–µ—Ä–µ–±—Ä–∞ –±–ª–µ–¥–Ω–æ-–∂—ë–ª—Ç–æ–≥–æ —Ü–≤–µ—Ç–∞.",
      "—Å–∏–Ω–µ–∫–¥–æ—Ö–∞":"–§–∏–≥—É—Ä–∞ —Ä–µ—á–∏: —á–∞—Å—Ç—å –≤–º–µ—Å—Ç–æ —Ü–µ–ª–æ–≥–æ –∏–ª–∏ –Ω–∞–æ–±–æ—Ä–æ—Ç.",
      "–∞–Ω—Ñ–∏–ª–∞–¥–∞":"–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–æ–º–Ω–∞—Ç –ø–æ –æ–¥–Ω–æ–π –æ—Å–∏ —Å –ø—Ä–æ—Ö–æ–¥–∞–º–∏.",
      "–ø—Ä–æ—Ç–æ–º–∞":"–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥–æ–ª–æ–≤—ã –∏ –≤–µ—Ä—Ö–Ω–µ–π —á–∞—Å—Ç–∏ –≥—Ä—É–¥–∏ (—Å–∫—É–ª—å–ø—Ç—É—Ä–∞/—Ä–µ–ª—å–µ—Ñ).",
      "—Å–∏–Ω—Ö—Ä–æ—Ñ–∞–∑–æ—Ç—Ä–æ–Ω":"–ö—Ä—É–ø–Ω—ã–π —É—Å–∫–æ—Ä–∏—Ç–µ–ª—å –∑–∞—Ä—è–∂–µ–Ω–Ω—ã—Ö —á–∞—Å—Ç–∏—Ü –∫–æ–ª—å—Ü–µ–≤–æ–≥–æ —Ç–∏–ø–∞."
    };
    const SAMPLE_SHORT = {
      "–±–∏—Ä—é–ª—å–∫–∏":"–ú–µ–ª–∫–∏–µ –±–µ–∑–¥–µ–ª—É—à–∫–∏; —Ç–∞–∫–∂–µ –Ω–∞—Å—Ç–æ–ª—å–Ω–∞—è –∏–≥—Ä–∞ —Å –∫—Ä—é—á–∫–æ–º.",
      "—à–ø–∏–Ω–¥–µ–ª—å":"–°—Ç–µ—Ä–∂–µ–Ω—å –¥–ª—è –ø—Ä—è–¥–µ–Ω–∏—è; –≤–µ—Ä–µ—Ç–µ–Ω–æ –ø—Ä—è–ª–∫–∏.",
      "–±–∞–ª—è—Å–∏–Ω–∞":"–§–∏–≥—É—Ä–Ω—ã–π —Å—Ç–æ–ª–±–∏–∫ –ø–µ—Ä–∏–ª –ª–µ—Å—Ç–Ω–∏—Ü—ã.",
      "–∫–æ–∫–ª—é—à–∫–∏":"–î–µ—Ä–µ–≤—è–Ω–Ω—ã–µ –ø–∞–ª–æ—á–∫–∏ –¥–ª—è –ø–ª–µ—Ç–µ–Ω–∏—è –∫—Ä—É–∂–µ–≤.",
      "—Ç—Ä–¥–µ–ª—å–Ω–∏–∫":"–°–ª–∞–¥–∫–∞—è —Ç—Ä—É–±–æ—á–∫–∞ –Ω–∞ –≤–µ—Ä—Ç–µ–ª–µ (–ß–µ—Ö–∏—è).",
      "—à–∫–µ—Ç":"–ú–∞–ª—å—á–∏—à–∫–∞, –º–µ–ª–∫–∏–π –ø–∞—Ä–Ω–∏—à–∫–∞ (—Ä–∞–∑–≥.)."
    };

    // Initialize default decks if empty ‚Äî load from files on startup
    async function initDecks() {
      if (Object.keys(LS.getHigh()).length === 0) {
        const high = await fetchDeck('./decks/long.json');
        LS.saveHigh(high || SAMPLE_HIGH);
      }
      if (Object.keys(LS.getShort()).length === 0) {
        const short = await fetchDeck('./decks/short.json');
        LS.saveShort(short || SAMPLE_SHORT);
      }
    }

    // ---------- State ----------
    const state = {
      game:null,
      timer:null,
    };

    function newGameFromUI(){
      const teamCount = +$('#teamCount').value;
      const names = uniqueTeamNames(teamCount);
      const teams = Array.from({length:teamCount},(_,i)=>({id:uid(), name:$('#teamName'+i)?.value||names[i], color:randColor(), score:0}));
      const settings = {
        target:+$('#targetScore').value||30,
        roundTime:+$('#roundTime').value||60,
        skipPenalty:+$('#skipPenalty').value||0,
        enabledDecks:{high:$('#enableHigh').checked, short:$('#enableShort').checked}
      };
      const pool = buildWordPool(settings.enabledDecks);
      state.game = {
        id:uid(), createdAt:Date.now(),
        teams, order:[...teams.keys()], curTeamIdx:0,
        settings,
        pool, used:new Set(),
        round:{ index:1, deadline:0, timeUp:false, current:null, hint:false, words:[], stats:{guessed:0, guessedHint:0, skips:0, delta:0} }
      };
    }

    function buildWordPool(enabledDecks){
      const high = LS.getHigh();
      const short = LS.getShort();
      const mix = [];
      if(enabledDecks.high){
        mix.push(...Object.entries(high));
      }
      if(enabledDecks.short){
        mix.push(...Object.entries(short));
      }
      // shuffle
      for(let i=mix.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[mix[i],mix[j]]=[mix[j],mix[i]]}
      return mix; // array of [word,hint]
    }

    function randColor(){
      const h=Math.floor(Math.random()*360);
      return `hsl(${h} 70% 55%)`;
    }

    function renderTeamsSetup(){
      const n=+$('#teamCount').value;
      const names = uniqueTeamNames(n);
      const box=$('#teamsBox');
      box.innerHTML='';
      for(let i=0;i<n;i++){
        const d=document.createElement('div');
        d.className='card';
        d.innerHTML=`<label>–ö–æ–º–∞–Ω–¥–∞ ${i+1}</label>
          <input id="teamName${i}" type="text" value="${names[i]}" />
          <span class="pill">–ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è ‚Ä¢ –º–æ–∂–Ω–æ –ø—Ä–∞–≤–∏—Ç—å</span>`;
        box.appendChild(d);
      }
    }

    // ---------- Round mechanics ----------
    function startRound(){
      const g=state.game;
      g.round = { index:g.round.index, deadline: Date.now()+g.settings.roundTime*1000, timeUp:false, current:null, hint:false, words:[], stats:{guessed:0, guessedHint:0, skips:0, delta:0} };
      nextWord();
      showScreen('round');
      tick();
    }

    function timeLeftMs(){ return Math.max(0, (state.game.round.deadline - Date.now())) }

    function tick(){
      cancelAnimationFrame(state.timer);
      const loop=()=>{
        const ms=timeLeftMs();
        const sec=Math.ceil(ms/1000);
        $('#timeLeft').textContent=`${fmt(Math.floor(sec/60))}:${fmt(sec%60)}`;
        const total=state.game.settings.roundTime*1000;
        const p=1 - (ms/total);
        $('#barFill').style.inset = `0 ${Math.max(0,(1-p)*100)}% 0 0`;
        if(ms<=0 && !state.game.round.timeUp){
          state.game.round.timeUp=true;
          $('#btnEndRound').disabled=true;
          $('#btnHint').disabled=false;
          $('#btnGuessed').disabled=false;
          $('#btnSkip').disabled=false;
          toast('‚è∞ –í—Ä–µ–º—è! –¢–µ–∫—É—â–µ–µ —Å–ª–æ–≤–æ ‚Äî –±–µ–∑ –ª–∏–º–∏—Ç–∞');
        }
        state.timer=requestAnimationFrame(loop);
      };
      state.timer=requestAnimationFrame(loop);
    }

    function nextWord(){
      const g=state.game;
      if(g.round.timeUp){ return; }
      while(g.pool.length){
        const [w,h]=g.pool.pop();
        const key=w+"\u0000"+h; // avoid accidental collisions; explicit escape
        if(!g.used.has(key)){
          g.used.add(key);
          g.round.current={w,h};
          g.round.hint=false;
          renderWord();
          return;
        }
      }
      toast('–°–ª–æ–≤–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –¥–µ–∫–∞—Ö. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –±–æ–ª—å—à–µ —Å–ª–æ–≤.');
    }

    function fitWord(){
      const el = $('#wordText');
      const parentWidth = el.parentElement.clientWidth - 24; // padding reserve
      let size = 48;
      el.style.fontSize = size + 'px';
      el.style.whiteSpace = 'nowrap';
      // downscale until fits; min 18px
      while(el.scrollWidth > parentWidth && size > 18){
        size -= 2;
        el.style.fontSize = size + 'px';
      }
    }

    function renderWord(){
      const {w,h}=state.game.round.current;
      const wordEl = $('#wordText');
      wordEl.textContent=w;
      $('#hintText').textContent = state.game.round.hint ? h : '–ü–æ–¥—Å–∫–∞–∑–∫–∞ —Å–∫—Ä—ã—Ç–∞';
      updateHeader();
      // ensure fits on mobile
      requestAnimationFrame(fitWord);
    }

    function scoreCurrent(guessed){
      const r=state.game.round;
      const team=state.game.teams[state.game.order[state.game.curTeamIdx]];
      if(guessed){
        const add = r.hint?1:2;
        team.score += add;
        r.stats.guessed += 1;
        if(r.hint) r.stats.guessedHint += 1;
        r.stats.delta += add;
        r.words.push({w:r.current.w, result:'ok', hint:r.hint, pts:add});
        if(!r.timeUp){ nextWord(); }
        else { finishRound(); }
      } else {
        const pen = state.game.settings.skipPenalty || 0;
        team.score += pen;
        r.stats.skips += 1;
        r.stats.delta += pen;
        r.words.push({w:r.current.w, result:'skip', hint:r.hint, pts:pen});
        if(!r.timeUp){ nextWord(); }
        else { finishRound(); }
      }
      updateHeader();
    }

    function updateHeader(){
      const g=state.game; const r=g.round; const team=g.teams[g.order[g.curTeamIdx]];
      const tag=$('#roundTeamTag');
      tag.querySelector('.team-color').style.background=team.color;
      tag.querySelector('.name').textContent=team.name;
      $('#scoreTag').textContent = `–°—á—ë—Ç: ${g.teams.map(t=>t.score).join(' : ')}`;
      $('#roundInfo').textContent = `–†–∞—É–Ω–¥ ${r.index}`;
    }

    function finishRound(){
      cancelAnimationFrame(state.timer);
      const g=state.game; const r=g.round;
      renderScoreSummary();
      showScreen('score');
      g.curTeamIdx = (g.curTeamIdx + 1) % g.teams.length;
      g.round.index += 1;
      const winner = g.teams.find(t=>t.score>=g.settings.target);
      if(winner){ renderMatchEnd(winner); }
    }

    function renderScoreSummary(){
      const g=state.game;
      const table=$('#scoreTable');
      table.innerHTML='';
      g.teams.forEach((t)=>{
        const card=document.createElement('div');
        card.className='card';
        card.innerHTML=`<div class="row" style="justify-content:space-between;align-items:center">
          <div class="team-tag"><span class="team-color" style="background:${t.color}"></span><b>${t.name}</b></div>
          <div class="pill">–û—á–∫–∏: <b>${t.score}</b></div>
        </div>`;
        table.appendChild(card);
      });
      const box=$('#wordsSummary');
      box.innerHTML='';
      state.game.round.words.forEach(rec=>{
        const line=document.createElement('div');
        const icon = rec.result==='ok' ? (rec.hint?'üí°‚úÖ':'‚úÖ') : '‚è≠';
        line.className='row';
        line.style.justifyContent='space-between';
        line.innerHTML=`<div>${icon} <b>${rec.w}</b></div><div class="pill">${rec.pts>0?'+':''}${rec.pts} –æ—á–∫.</div>`;
        box.appendChild(line);
      })
    }

    function renderMatchEnd(winner){
      const g=state.game;
      const rec={ id:g.id, finishedAt:Date.now(), winner:winner.name, scores:g.teams.map(t=>({name:t.name,score:t.score})), settings:g.settings };
      LS.pushHistory(rec);
      $('#winnerTitle').textContent = `–ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${winner.name}`;
      const box=$('#finalScore');
      box.innerHTML='';
      g.teams
        .slice()
        .sort((a,b)=>b.score-a.score)
        .forEach(t=>{
          const d=document.createElement('div');
          d.className='card';
          d.innerHTML = `<div class="row" style="justify-content:space-between;align-items:center">
            <div class="team-tag"><span class="team-color" style="background:${t.color}"></span><b>${t.name}</b></div>
            <div class="pill">${t.score} –æ—á–∫–æ–≤</div>
          </div>`;
          box.appendChild(d);
        });
      showScreen('end');
    }

    function toast(msg){
      const el=document.createElement('div');
      el.textContent=msg; el.className='pill';
      el.style.position='fixed'; el.style.bottom='20px'; el.style.left='50%'; el.style.transform='translateX(-50%)';
      el.style.zIndex='9999'; el.style.background='#0b0e14'; el.style.border='1px solid #3a4566';
      document.body.appendChild(el);
      setTimeout(()=>{el.remove()}, 2200);
    }

    // ---------- Screens ----------
    function showScreen(which){
      $('#screen-setup').style.display = which==='setup'?'block':'none';
      $('#screen-round').style.display = which==='round'?'block':'none';
      $('#screen-score').style.display = which==='score'?'block':'none';
      $('#screen-end').style.display   = which==='end'?'block':'none';
      $('#screen-history').style.display = which==='history'?'block':'none';
    }

    // ---------- Event bindings ----------
    $('#teamCount').addEventListener('change', renderTeamsSetup);
    $('#rerollNames').addEventListener('click', renderTeamsSetup);
    $('#swapOrder').addEventListener('click', ()=>{
      if(!state.game) return; state.game.order = state.game.order.sort(()=>Math.random()-.5); toast('–ü–æ—Ä—è–¥–æ–∫ –∫–æ–º–∞–Ω–¥ –ø–µ—Ä–µ–º–µ—à–∞–Ω');
    });

    const howToText = `–ü—Ä–∞–≤–∏–ª–∞:
‚Äî +2 –æ—á–∫–∞ –∑–∞ —Å–ª–æ–≤–æ –±–µ–∑ —Ö–∏–Ω—Ç–∞, +1 –µ—Å–ª–∏ —Ö–∏–Ω—Ç –ø–æ–∫–∞–∑–∞–Ω.
‚Äî –ü—Ä–æ–ø—É—Å–∫ 0 –∏–ª–∏ ‚àí1 (—Å–º. –Ω–∞—Å—Ç—Ä–æ–π–∫–∏).
‚Äî –ü–æ –æ–∫–æ–Ω—á–∞–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–∏ —Ç–µ–∫—É—â–µ–µ —Å–ª–æ–≤–æ –º–æ–∂–Ω–æ –¥–æ–æ–±—ä—è—Å–Ω–∏—Ç—å –±–µ–∑ –ª–∏–º–∏—Ç–∞.`;

    $('#startGame').addEventListener('click', ()=>{
      newGameFromUI();
      const t=state.game.teams[state.game.order[state.game.curTeamIdx]];
      $('#roundTeamTag .team-color').style.background=t.color;
      $('#roundTeamTag .name').textContent=t.name;
      startRound();
    });

    $('#howTo').addEventListener('click', ()=>{
      alert(howToText);
    });

    // Round controls
    $('#btnHint').addEventListener('click', ()=>{
      const r=state.game.round; if(!r.current) return;
      if(!r.hint){ r.hint=true; $('#hintText').textContent=r.current.h; }
    });
    $('#btnGuessed').addEventListener('click', ()=>{ scoreCurrent(true); });
    $('#btnSkip').addEventListener('click', ()=>{ scoreCurrent(false); });
    $('#btnEndRound').addEventListener('click', ()=>{ state.game.round.timeUp=true; toast('‚è∞ –í—Ä–µ–º—è! –¢–µ–∫—É—â–µ–µ —Å–ª–æ–≤–æ ‚Äî –±–µ–∑ –ª–∏–º–∏—Ç–∞'); });
    $('#btnPause').addEventListener('click', ()=>{ alert('–ü–∞—É–∑–∞ —É—Å–ª–æ–≤–Ω–∞—è –≤ —ç—Ç–æ–º MVP.'); });

    // Score summary
    $('#btnNextTeam').addEventListener('click', ()=>{
      const winner = state.game.teams.find(t=>t.score>=state.game.settings.target);
      if(winner){ renderMatchEnd(winner); return; }
      showScreen('round');
      startRound();
    });

    // Match end
    $('#btnRematch').addEventListener('click', ()=>{
      const g=state.game;
      g.teams.forEach(t=>t.score=0);
      g.pool = buildWordPool(g.settings.enabledDecks);
      g.used = new Set();
      g.curTeamIdx = 0; g.round.index = 1;
      showScreen('round');
      startRound();
    });
    $('#btnNew').addEventListener('click', ()=>{ showScreen('setup'); });
    $('#btnHistoryFromEnd').addEventListener('click', ()=>{ renderHistory(); showScreen('history'); });

    // History
    $('#historyBtn').addEventListener('click', ()=>{ renderHistory(); showScreen('history'); });
    $('#clearHistory').addEventListener('click', ()=>{ if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –º–∞—Ç—á–µ–π?')){ LS.clearHistory(); renderHistory(); } });
    $('#backFromHistory').addEventListener('click', ()=> showScreen('setup'));

    function renderHistory(){
      const list=$('#historyList'); list.innerHTML='';
      const arr=LS.getHistory();
      if(arr.length===0){ list.innerHTML='<p>–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞.</p>'; return; }
      arr.forEach(rec=>{
        const d=document.createElement('div'); d.className='card';
        const dt = new Date(rec.finishedAt).toLocaleString();
        const scores = rec.scores.map(s=>`${s.name}: <b>${s.score}</b>`).join(' ¬∑ ');
        d.innerHTML=`<div class="row" style="justify-content:space-between;align-items:center"><div><div class="pill">${dt}</div><div style="margin-top:6px">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å: <b>${rec.winner}</b></div></div><div>${scores}</div></div>`;
        list.appendChild(d);
      })
    }

    // ---------- Self-tests (run once on load) ----------
    function runSelfTests(){
      try{
        // 1) uniqueTeamNames: n unique labels
        const n=4; const names=uniqueTeamNames(n); const set=new Set(names);
        console.assert(set.size===n, 'uniqueTeamNames should produce unique names per roll');
        // 2) buildWordPool returns array and respects enabledDecks
        const poolBoth = buildWordPool({high:true, short:true});
        console.assert(Array.isArray(poolBoth), 'pool both should be array');
        const poolHigh = buildWordPool({high:true, short:false});
        const poolShort = buildWordPool({high:false, short:true});
        console.assert(Array.isArray(poolHigh)&&Array.isArray(poolShort), 'pools should be arrays');
        // 3) howToText is multiline template literal (no syntax errors)
        console.assert(howToText.includes('–ü—Ä–∞–≤–∏–ª–∞'), 'howToText accessible');
        console.log('‚úÖ Self-tests passed');
      }catch(e){ console.error('‚ùå Self-tests failed', e); }
    }

    // Resize: refit word on rotate/or resize
    window.addEventListener('resize', ()=>{ if($('#screen-round').style.display==='block') fitWord(); });

    // ---- Defaults loader from ./decks/*.json ----
    async function fetchDeck(path){
      try{ const res = await fetch(path, {cache:'no-store'}); if(!res.ok) throw new Error(res.statusText); return await res.json(); }
      catch(e){ toast(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å ${path}`); console.error('Default deck load error', e); return null; }
    }

    // Initial
    renderTeamsSetup();
    runSelfTests();
    initDecks();

  </script>
</body>
</html>
